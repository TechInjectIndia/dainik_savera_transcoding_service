function wrapFetch(server, fetchHandler) {
  const plugins = server.options.plugins;
  if (!plugins?.length) {
    return fetchHandler;
  }
  const requestHooks = [];
  const responseHooks = [];
  for (const ctor of plugins) {
    const plugin = typeof ctor === "function" ? ctor(server) : ctor;
    if (plugin.request) {
      requestHooks.push(plugin.request);
    }
    if (plugin.response) {
      responseHooks.push(plugin.response);
    }
  }
  const hasRequestHooks = requestHooks.length > 0;
  const hasResponseHooks = responseHooks.length > 0;
  if (!hasRequestHooks && !hasResponseHooks) {
    return fetchHandler;
  }
  return (request) => {
    let resValue;
    let resPromise;
    if (hasRequestHooks) {
      for (const reqHook of requestHooks) {
        if (resPromise) {
          resPromise = resPromise.then((res) => res || reqHook(request));
        } else {
          const res = reqHook(request);
          if (res) {
            if (res instanceof Promise) {
              resPromise = res;
            } else {
              return res;
            }
          }
        }
      }
    }
    if (resPromise) {
      resPromise = resPromise.then((res) => res || fetchHandler(request));
    } else {
      const res = fetchHandler(request);
      if (res instanceof Promise) {
        resPromise = res;
      } else {
        resValue = res;
      }
    }
    if (hasResponseHooks) {
      for (const resHook of responseHooks) {
        if (resPromise) {
          resPromise = resPromise.then((res) => {
            if (res) {
              resValue = res;
            }
            return resHook(request, resValue);
          });
        } else {
          const res = resHook(request, resValue);
          if (res) {
            if (res instanceof Promise) {
              resPromise = res;
            } else {
              resValue = res;
            }
          }
        }
      }
    }
    return resPromise ? resPromise.then((res) => res || resValue) : resValue;
  };
}

export { wrapFetch as w };
